


<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>インスタ風チャットルーム</title>
  <script src="/socket.io/socket.io.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: "Poppins", sans-serif;
      margin: 0;
      background-color: #fafafa;
      color: #262626;
    }
    h1, h2 {
      text-align: center;
      color: #262626;
    }
    #usernameDisplay {
      text-align: center;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .room-container {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .room-button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #3897f0;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .room-button:hover {
      background-color: #2f81d9;
    }
    .info {
      text-align: center;
      font-size: 14px;
      color: #999;
    }
    #chat-box {
      width: 90%;
      max-width: 600px;
      height: 400px;
      margin: 0 auto;
      background: white;
      border: 1px solid #dbdbdb;
      border-radius: 10px;
      padding: 10px;
      overflow-y: scroll;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      padding: 8px 12px;
      border-radius: 18px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .self {
      background-color: #dcf8c6;
      align-self: flex-end;
    }
    .other {
      background-color: #f1f0f0;
      align-self: flex-start;
    }
    #input-area {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px auto;
      gap: 10px;
      width: 90%;
      max-width: 600px;
    }
    #message-input {
      flex-grow: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #dbdbdb;
      border-radius: 10px;
    }
    #send-button, #send-file-button {
      padding: 10px 15px;
      font-size: 16px;
      background-color: #3897f0;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #send-button:hover, #send-file-button:hover {
      background-color: #2f81d9;
    }
    #fileModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 100vw;
      background-color: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #fileModalContent {
      max-width: 90vw;
      max-height: 90vh;
    }
    .close-button {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 30px;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>インスタ風チャットルーム</h1>
  <p id="usernameDisplay"></p>

  <h2>入りたい部屋を選択してください</h2>
  <div class="room-container">
    <button class="room-button" onclick="joinRoom('雑談部屋')">雑談部屋</button>
    <button class="room-button" onclick="joinRoom('雑談部屋2')">雑談部屋2</button>
  </div>

  <p class="info">メッセージが読み込まれない場合は、もう一度部屋を押してください</p>

  <h2>チャットルーム: <span id="roomTitle">雑談部屋</span></h2>

  <div id="chat-box"></div>

  <div id="input-area">
    <input type="text" id="message-input" placeholder="メッセージを入力..." autocomplete="off" />
    <button id="send-button">送信</button>
  </div>

  <div id="input-area" style="gap:1rem;">
    <input type="file" id="fileInput" />
    <button id="send-file-button">ファイル送信</button>
  </div>

  <div id="fileModal">
    <div id="fileModalContent"></div>
    <button class="close-button" onclick="closeModal()">×</button>
  </div>

  <script>
    const socket = io();
    const username = localStorage.getItem("username") || "ゲスト";
    let currentRoom = localStorage.getItem("currentRoom") || "雑談部屋";

    document.getElementById("usernameDisplay").textContent = `ログインユーザー: ${username}`;

    function joinRoom(room) {
      localStorage.setItem("currentRoom", room);
      currentRoom = room;
      document.getElementById("roomTitle").textContent = room;
      socket.emit("joinRoom", room);
      fetchMessages();
    }

    function addMessageToChatBox(msg) {
      const chatBox = document.getElementById("chat-box");
      let displayMsg = msg.text ? msg.text : getFilePreview(msg.file);

      const div = document.createElement("div");
      div.classList.add("message");
      div.classList.add(msg.user === username ? "self" : "other");
      div.innerHTML = `<strong>${msg.user}</strong> ${displayMsg}`;

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function fetchMessages() {
      const response = await fetch(`/messages?room=${currentRoom}`);
      const messages = await response.json();
      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML = "";

      messages.forEach(msg => {
        addMessageToChatBox(msg);
      });
    }

    function getFilePreview(fileUrl) {
      if (!fileUrl) return "";

      if (fileUrl.match(/\.(png|jpg|jpeg|gif)$/)) {
        return `<button onclick="showFile('${fileUrl}', 'image')" style="border:none; background:none; color:#bc1888; cursor:pointer;">🔍 画像を見る</button>`;
      } else if (fileUrl.match(/\.(mp4|webm)$/)) {
        return `<button onclick="showFile('${fileUrl}', 'video')" style="border:none; background:none; color:#bc1888; cursor:pointer;">▶ 動画を見る</button>`;
      } else if (fileUrl.match(/\.(pdf|txt)$/)) {
        return `<button onclick="showFile('${fileUrl}', 'document')" style="border:none; background:none; color:#bc1888; cursor:pointer;">📄 ファイルを見る</button>`;
      } else {
        return `<a href="${fileUrl}" target="_blank" style="color:#bc1888; text-decoration:none;">📎 ファイルを開く</a>`;
      }
    }

    function showFile(fileUrl, type) {
      let content = "";
      if (type === "image") {
        content = `<img src="${fileUrl}" alt="拡大画像" style="max-width:90vw; max-height:90vh; border-radius:15px;">`;
      } else if (type === "video") {
        content = `<video src="${fileUrl}" controls autoplay style="max-width:90vw; max-height:90vh; border-radius:15px;"></video>`;
      } else if (type === "document") {
        content = `<iframe src="${fileUrl}" width="90vw" height="90vh" style="border:none; border-radius:15px;"></iframe>`;
      }

      document.getElementById("fileModalContent").innerHTML = content;
      document.getElementById("fileModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("fileModal").style.display = "none";
    }

    socket.on("message", (msg) => {
      if (msg.room === currentRoom) {
        addMessageToChatBox(msg);
      }
    });

    document.getElementById("send-button").addEventListener("click", () => {
      const message = document.getElementById("message-input").value;
      if (!message.trim()) return;

      fetch("/send-message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, username, room: currentRoom }),
      }).then(() => {
        document.getElementById("message-input").value = "";
      });
    });

    document.getElementById("send-file-button").addEventListener("click", async () => {
      const fileInput = document.getElementById("fileInput").files[0];
      if (!fileInput) {
        alert("ファイルを選択してください！");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput);
      formData.append("username", username);
      formData.append("room", currentRoom);

      try {
        const response = await fetch("/upload", {
          method: "POST",
          body: formData,
        });
        const result = await response.json();
        if (!result.success) {
          alert("ファイル送信に失敗しました！💥");
        }
      } catch (error) {
        console.error("ファイル送信エラー:", error);
        alert("ファイル送信中に問題が発生しました！💥");
      }
    });

    window.onload = () => {
      document.getElementById("roomTitle").textContent = currentRoom;
      socket.emit("joinRoom", currentRoom);
      fetchMessages();
    };
  </script>
</body>
</html>

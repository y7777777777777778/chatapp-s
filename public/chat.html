
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒãƒ£ãƒƒãƒˆ</title>
<style>
  /* Reset & basic */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆï¼‰ */
  #userList {
    width: 220px;
    background: #fff;
    border-right: 1px solid #ddd;
    padding: 15px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.05);
    overflow-y: auto;
  }
  #userList b {
    display: block;
    margin-bottom: 10px;
    font-size: 18px;
    color: #333;
  }
  #users {
    font-size: 14px;
    color: #555;
    word-wrap: break-word;
  }

  /* ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆé ˜åŸŸ */
  .chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ */
  #chat {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #e5ddd5;
  }

  /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ç´°ãã¦ç›®ç«‹ã¡ã«ãã */
  #chat::-webkit-scrollbar {
    width: 8px;
  }
  #chat::-webkit-scrollbar-track {
    background: transparent;
  }
  #chat::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.1);
    border-radius: 4px;
  }

  /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¹ãå‡ºã— */
  .message {
    max-width: 60%;
    margin-bottom: 12px;
    padding: 10px 15px;
    border-radius: 18px;
    position: relative;
    word-wrap: break-word;
    box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    font-size: 15px;
  }

  /* è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å³å¯„ã›ã€è‰²ã‚‚é•ã† */
  .message.self {
    margin-left: auto;
    background: #dcf8c6;
    color: #222;
  }

  /* ä»–äººã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å·¦å¯„ã› */
  .message.other {
    background: #fff;
    color: #333;
  }

  /* ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
  .message.system {
    background: transparent;
    color: #777;
    font-style: italic;
    text-align: center;
    max-width: 100%;
  }

  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼å */
  .username {
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
  }

  /* ç”»åƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
  .message img {
    max-width: 100%;
    border-radius: 12px;
    margin-top: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
  #form {
    display: flex;
    padding: 12px 15px;
    background: #fff;
    border-top: 1px solid #ddd;
  }
  #input {
    flex: 1;
    padding: 10px 15px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 25px;
    outline: none;
    transition: border-color 0.3s;
  }
  #input:focus {
    border-color: #4caf50;
    box-shadow: 0 0 5px #4caf50;
  }

  /* ãƒœã‚¿ãƒ³ */
  #sendBtn, #imageBtn {
    background: #4caf50;
    border: none;
    color: white;
    padding: 0 20px;
    margin-left: 10px;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #sendBtn:hover, #imageBtn:hover {
    background: #45a049;
  }
  #sendBtn:active, #imageBtn:active {
    background: #3b8e40;
  }

  /* ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã¯éè¡¨ç¤º */
  #imageInput {
    display: none;
  }

  /* ã‚¹ãƒãƒ›å¯¾å¿œ */
  @media (max-width: 600px) {
    #userList {
      display: none;
    }
    .chat-container {
      height: 100vh;
    }
  }
</style>
</head>
<body>

<div id="userList">
  <b>å‚åŠ ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼</b>
  <div id="users"></div>
</div>

<div class="chat-container">
  <div id="chat"></div>
  <form id="form" autocomplete="off">
    <input id="input" autocomplete="off" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
    <button id="imageBtn" type="button" title="ç”»åƒé€ä¿¡">ğŸ“·</button>
    <button id="sendBtn" type="submit">é€ä¿¡</button>
    <input type="file" id="imageInput" accept="image/*" />
  </form>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // URLã‹ã‚‰usernameå–å¾—
  const urlParams = new URLSearchParams(window.location.search);
  const username = urlParams.get('username') || 'åŒ¿å';

  const socket = io({ query: { username } });

  const chat = document.getElementById('chat');
  const form = document.getElementById('form');
  const input = document.getElementById('input');
  const userListSpan = document.getElementById('users');
  const imageBtn = document.getElementById('imageBtn');
  const imageInput = document.getElementById('imageInput');

  function addMessage(message) {
    const div = document.createElement('div');
    div.classList.add('message');

    // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯selfã‚¯ãƒ©ã‚¹ã€ä»–ã¯otherã€ã‚·ã‚¹ãƒ†ãƒ ã¯system
    if(message.type === 'text') {
      if(message.username === username) {
        div.classList.add('self');
      } else if (message.username === 'ã‚·ã‚¹ãƒ†ãƒ ') {
        div.classList.add('system');
      } else {
        div.classList.add('other');
      }
      div.innerHTML = `<span class="username">${escapeHtml(message.username)}</span>${escapeHtml(message.text)}`;
    } else if (message.type === 'image') {
      if(message.username === username) {
        div.classList.add('self');
      } else if (message.username === 'ã‚·ã‚¹ãƒ†ãƒ ') {
        div.classList.add('system');
      } else {
        div.classList.add('other');
      }
      div.innerHTML = `<span class="username">${escapeHtml(message.username)}</span><br><img src="${message.url}" alt="ç”»åƒ" />`;
    }
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'}[m];
    });
  }

  socket.on('chat message', (msg) => {
    addMessage(msg);
  });

  socket.on('userList', (users) => {
    userListSpan.textContent = users.join(', ');
  });

  socket.on('clear messages', () => {
    chat.innerHTML = '';
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;
    socket.emit('chat message', text);
    input.value = '';
  });

  imageBtn.addEventListener('click', () => {
    imageInput.click();
  });

  imageInput.addEventListener('change', () => {
    const file = imageInput.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
      alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    const formData = new FormData();
    formData.append('image', file);

    fetch('/upload', {
      method: 'POST',
      body: formData,
    })
    .then((res) => res.json())
    .then((data) => {
      if (data.imageUrl) {
        socket.emit('chat message', { type: 'image', url: data.imageUrl });
      } else {
        alert('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    })
    .catch(() => alert('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ'));

    imageInput.value = '';
  });
</script>

</body>
</html>

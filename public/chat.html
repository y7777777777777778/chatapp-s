<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #chatContainer { border: 2px solid #000; padding: 10px; width: 400px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h1>

    <div id="chatContainer">
        <p id="usernameDisplay"></p> 
        <select id="roomSelect">
            <option value="é›‘è«‡éƒ¨å±‹">é›‘è«‡éƒ¨å±‹ï¼ˆä¸‹ãƒã‚¿ãƒ»æš´è¨€ç¦æ­¢ï¼‰</option>
            <option value="é›‘è«‡éƒ¨å±‹2">é›‘è«‡éƒ¨å±‹2ï¼ˆä¸‹ãƒã‚¿ãƒ»æš´è¨€OKï¼‰</option>
            <option value="PCç‰¹åŒ–éƒ¨å±‹">PCç‰¹åŒ–éƒ¨å±‹</option>
        </select>
        <button onclick="joinRoom()">éƒ¨å±‹ã«å…¥ã‚‹</button>
        <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <div id="messages"></div>
        <input id="messageInput" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
        <button onclick="sendMessage()">é€ä¿¡</button>
        <input id="fileInput" type="file" />
        <button onclick="sendFile()">ç”»åƒãƒ»å‹•ç”»ã‚’é€ä¿¡</button>
    </div>

    <script>
        if (localStorage.getItem("authenticated") !== "true") {
            window.location.href = "index.html";
        }

        const socket = io();
        const username = localStorage.getItem("username") || "ã‚²ã‚¹ãƒˆ";
        let currentRoom = "é›‘è«‡éƒ¨å±‹";

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("usernameDisplay").textContent = `ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${username}`;
            socket.emit("joinRoom", currentRoom);
        });

        socket.on('messageHistory', (history) => {
            document.getElementById('messages').innerHTML = "";
            history.forEach((data) => {
                if (data.username && data.message) {
                    addMessageToChat(data);
                } else if (data.data) {
                    displayFile(data);
                }
            });
        });

        socket.on('message', (data) => {
            addMessageToChat(data);
        });

        socket.on('file', (file) => {
            displayFile(file);
        });

        function joinRoom() {
            currentRoom = document.getElementById("roomSelect").value;
            console.log(`ğŸ”¹ éƒ¨å±‹é¸æŠ: ${currentRoom}`);
            socket.emit("joinRoom", currentRoom);
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (!message.trim()) return;
            const data = { username, message, room: currentRoom };
            socket.emit('message', data);
        }

        function sendFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                const fileData = { username, data: reader.result, room: currentRoom };
                socket.emit('file', fileData);
            };
            reader.readAsDataURL(file);
        }

        function addMessageToChat(data) {
            const div = document.createElement('div');
            div.innerHTML = `<strong>${data.username}</strong>: ${data.message}`;
            document.getElementById('messages').appendChild(div);
        }

        function displayFile(file) {
            if (!file.data) return;
            const container = document.createElement('div');
            const button = document.createElement('button');
            button.textContent = "ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹";
            button.onclick = () => {
                image.classList.toggle('hidden');
            };
            const image = document.createElement(file.data.startsWith("data:image") ? 'img' : 'video');
            image.src = file.data;
            image.controls = file.data.startsWith("data:video");
            image.classList.add('hidden');
            image.style.maxWidth = "100%";
            container.appendChild(button);
            container.appendChild(image);
            document.getElementById('messages').appendChild(container);
        }

        function logout() {
            localStorage.removeItem("authenticated");
            localStorage.removeItem("username");
            window.location.href = "index.html";
        }
    </script>
</body>
</html>


